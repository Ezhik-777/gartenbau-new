// Optimized JavaScript - Performance-focused rewrite
(function() {
'use strict';

// Performance-optimized preloader
class PreloaderManager {
  constructor() {
    this.preloader = document.getElementById('mainPreloader');
    this.progressBar = document.getElementById('progressBar');
    this.progressPercentage = document.getElementById('progressPercentage');
    this.progress = 0;
    this.loadedResources = 0;
    this.totalResources = 8;
    this.galleryImagesLoaded = 0;
    this.totalGalleryImages = 12;
    this.isGalleryLoading = false;
    
    this.init();
  }
  
  init() {
    this.bindEvents();
    this.simulateResourceLoading();
    this.setFailsafe();
  }
  
  bindEvents() {
    window.updatePreloaderProgress = (percentage) => this.updateProgress(percentage);
    window.setGalleryLoadingMode = (totalImages) => this.setGalleryLoadingMode(totalImages);
    window.incrementGalleryProgress = () => this.incrementGalleryProgress();
  }
  
  updateProgress(percentage) {
    this.progress = Math.min(percentage, 100);
    this.progressBar.style.width = this.progress + '%';
    this.progressPercentage.textContent = Math.round(this.progress) + '%';
  }
  
  setGalleryLoadingMode(totalImages) {
    this.isGalleryLoading = true;
    this.totalGalleryImages = totalImages;
    this.galleryImagesLoaded = 0;
    this.totalResources = 8 + totalImages;
    const baseProgress = (8 / this.totalResources) * 100;
    this.updateProgress(baseProgress);
  }
  
  incrementGalleryProgress() {
    if (this.isGalleryLoading) {
      this.galleryImagesLoaded++;
      const galleryProgress = (this.galleryImagesLoaded / this.totalGalleryImages) * 30;
      const baseProgress = 70;
      this.updateProgress(baseProgress + galleryProgress);
      
      if (this.galleryImagesLoaded >= this.totalGalleryImages) {
        this.finishPreloader();
      }
    }
  }
  
  incrementProgress() {
    this.loadedResources++;
    const newProgress = (this.loadedResources / this.totalResources) * (this.isGalleryLoading ? 70 : 90);
    this.updateProgress(newProgress);
  }
  
  finishPreloader() {
    setTimeout(() => {
      this.updateProgress(100);
      setTimeout(() => {
        this.preloader.classList.add('hidden');
        setTimeout(() => {
          if (this.preloader.parentNode) {
            this.preloader.parentNode.removeChild(this.preloader);
          }
        }, 500);
      }, 300);
    }, 200);
  }
  
  simulateResourceLoading() {
    const resources = [
      { name: 'CSS', delay: 200 },
      { name: 'Fonts', delay: 400 },
      { name: 'JavaScript', delay: 300 },
      { name: 'Hero Image', delay: 500 },
      { name: 'Service Images', delay: 600 },
      { name: 'Gallery System', delay: 300 },
      { name: 'Form Scripts', delay: 200 },
      { name: 'Final Setup', delay: 400 }
    ];
    
    resources.forEach((resource, index) => {
      setTimeout(() => {
        this.incrementProgress();
        if (this.loadedResources === 8 && !this.isGalleryLoading) {
          this.finishPreloader();
        }
      }, resource.delay + index * 100);
    });
  }
  
  setFailsafe() {
    setTimeout(() => {
      if (this.preloader && !this.preloader.classList.contains('hidden')) {
        this.finishPreloader();
      }
    }, 6000);
  }
}

// Optimized mobile menu
class MobileMenu {
  constructor() {
    this.burger = document.querySelector('.burger');
    this.headerCol = document.querySelector('.header__col');
    this.body = document.body;
    this.menuLinks = document.querySelectorAll('.head__mn-ul li a');
    
    this.init();
  }
  
  init() {
    this.bindEvents();
  }
  
  bindEvents() {
    this.burger?.addEventListener('click', () => this.toggleMenu());
    this.body.addEventListener('click', (e) => this.handleBodyClick(e));
    this.headerCol?.addEventListener('click', (e) => e.stopPropagation());
    this.menuLinks.forEach(link => {
      link.addEventListener('click', () => this.closeMenu());
    });
  }
  
  toggleMenu() {
    this.burger.classList.toggle('burger-open');
    this.body.classList.toggle('body-open');
    this.headerCol.classList.toggle('open');
  }
  
  closeMenu() {
    this.burger?.classList.remove('burger-open');
    this.body.classList.remove('body-open');
    this.headerCol?.classList.remove('open');
  }
  
  handleBodyClick(e) {
    if (this.burger?.classList.contains('burger-open')) {
      this.closeMenu();
    }
  }
}

// Optimized smooth scroll
class SmoothScroll {
  constructor() {
    this.anchorLinks = document.querySelectorAll('a[href^="#"]');
    this.init();
  }
  
  init() {
    this.bindEvents();
  }
  
  bindEvents() {
    this.anchorLinks.forEach(link => {
      link.addEventListener('click', (e) => this.handleClick(e));
    });
  }
  
  handleClick(e) {
    e.preventDefault();
    const targetId = e.currentTarget.getAttribute('href').substring(1);
    const targetElement = document.getElementById(targetId);
    
    if (targetElement) {
      const headerHeight = document.querySelector('.head')?.offsetHeight || 80;
      const targetPosition = targetElement.offsetTop - headerHeight - 20;
      this.smoothScrollTo(targetPosition, 400);
    }
  }
  
  smoothScrollTo(targetPosition, duration = 600) {
    const startPosition = window.pageYOffset;
    const distance = targetPosition - startPosition;
    let startTime = null;

    const animation = (currentTime) => {
      if (startTime === null) startTime = currentTime;
      const timeElapsed = currentTime - startTime;
      const run = this.easeInOutQuad(timeElapsed, startPosition, distance, duration);
      window.scrollTo(0, run);
      if (timeElapsed < duration) requestAnimationFrame(animation);
    };

    requestAnimationFrame(animation);
  }
  
  easeInOutQuad(t, b, c, d) {
    t /= d / 2;
    if (t < 1) return c / 2 * t * t + b;
    t--;
    return -c / 2 * (t * (t - 2) - 1) + b;
  }
}

// Optimized header scroll effect
class HeaderScroll {
  constructor() {
    this.header = document.querySelector('.head');
    this.throttleTimer = null;
    this.init();
  }
  
  init() {
    this.bindEvents();
  }
  
  bindEvents() {
    window.addEventListener('scroll', () => this.throttledScroll());
  }
  
  throttledScroll() {
    if (this.throttleTimer) return;
    
    this.throttleTimer = setTimeout(() => {
      this.handleScroll();
      this.throttleTimer = null;
    }, 10);
  }
  
  handleScroll() {
    if (window.scrollY > 50) {
      this.header?.classList.add('scrolled');
    } else {
      this.header?.classList.remove('scrolled');
    }
  }
}

// Optimized lazy loading for images
class LazyLoader {
  constructor() {
    this.images = document.querySelectorAll('img[loading="lazy"]');
    this.observer = null;
    this.init();
  }
  
  init() {
    if ('IntersectionObserver' in window) {
      this.setupIntersectionObserver();
    } else {
      this.loadAllImages();
    }
  }
  
  setupIntersectionObserver() {
    this.observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          this.loadImage(entry.target);
          this.observer.unobserve(entry.target);
        }
      });
    }, {
      rootMargin: '50px 0px',
      threshold: 0.01
    });
    
    this.images.forEach(img => this.observer.observe(img));
  }
  
  loadImage(img) {
    if (img.dataset.src) {
      img.src = img.dataset.src;
      img.removeAttribute('data-src');
    }
    
    img.addEventListener('load', () => {
      img.classList.add('loaded');
    });
  }
  
  loadAllImages() {
    this.images.forEach(img => this.loadImage(img));
  }
}

// Optimized gallery with pagination
class OptimizedGallery {
  constructor() {
    this.gallery = document.getElementById('galleryContainer');
    this.loader = document.getElementById('loader');
    this.pagination = document.getElementById('pagination');
    this.prevBtn = document.getElementById('prevPage');
    this.nextBtn = document.getElementById('nextPage');
    this.pageInfo = document.getElementById('pageInfo');
    
    this.totalImages = 180;
    this.currentPage = 1;
    this.imagesPerPage = 12;
    this.loadedImageCount = 0;
    
    this.init();
  }
  
  init() {
    if (!this.gallery) return;
    
    this.bindEvents();
    this.initializeGallery();
  }
  
  bindEvents() {
    this.prevBtn?.addEventListener('click', () => this.previousPage());
    this.nextBtn?.addEventListener('click', () => this.nextPage());
    window.addEventListener('resize', () => this.throttledResize());
  }
  
  initializeGallery() {
    if (typeof window.setGalleryLoadingMode === 'function') {
      window.setGalleryLoadingMode(this.imagesPerPage);
    }
    
    this.hideLoader();
    this.showGallery();
    
    if (this.isMobile()) {
      this.showCarousel();
    } else {
      this.showGridImages();
    }
  }
  
  hideLoader() {
    if (this.loader) {
      this.loader.style.display = 'none';
    }
  }
  
  showGallery() {
    if (this.gallery) {
      this.gallery.style.display = 'grid';
    }
  }
  
  createImageElement(imageNumber) {
    const imgSrc = `img/image_${imageNumber}.webp`;
    const a = document.createElement('a');
    a.href = imgSrc;
    a.className = 'premium-gallery-item';
    a.setAttribute('data-fancybox', 'gallery2');

    const img = document.createElement('img');
    img.src = imgSrc;
    img.loading = 'lazy';
    img.decoding = 'async';
    img.alt = `Gartenbau Projekt ${imageNumber} - Stuttgart Region`;
    img.className = 'gallery-image';
    
    const overlay = document.createElement('div');
    overlay.className = 'gallery-overlay';
    overlay.innerHTML = `
      <div class="overlay-content">
        <div class="view-button">
          <span class="view-icon">üëÅ</span>
          <span class="view-text">Ansehen</span>
        </div>
      </div>
    `;
    
    img.addEventListener('load', () => {
      this.loadedImageCount++;
      if (typeof window.incrementGalleryProgress === 'function') {
        window.incrementGalleryProgress();
      }
    });
    
    img.addEventListener('error', () => {
      this.loadedImageCount++;
      img.alt = `Projekt ${imageNumber} - Bild nicht verf√ºgbar`;
      if (typeof window.incrementGalleryProgress === 'function') {
        window.incrementGalleryProgress();
      }
    });
    
    a.appendChild(img);
    a.appendChild(overlay);
    return a;
  }
  
  showGridImages() {
    const startIndex = (this.currentPage - 1) * this.imagesPerPage;
    const endIndex = startIndex + this.imagesPerPage;
    
    this.gallery.innerHTML = '';
    this.gallery.className = 'premium-gallery-grid active';
    this.loadedImageCount = 0;
    
    for (let i = startIndex; i < endIndex && i < this.totalImages; i++) {
      const imageNumber = i + 1;
      if (imageNumber === 42) continue;
      
      const imageElement = this.createImageElement(imageNumber);
      this.gallery.appendChild(imageElement);
    }
    
    this.updatePagination();
    this.initializeFancybox();
  }
  
  updatePagination() {
    const totalPages = Math.ceil(this.totalImages / this.imagesPerPage);
    
    if (this.pageInfo) {
      this.pageInfo.textContent = `Seite ${this.currentPage} von ${totalPages}`;
    }
    
    if (this.prevBtn) {
      this.prevBtn.disabled = this.currentPage === 1;
    }
    
    if (this.nextBtn) {
      this.nextBtn.disabled = this.currentPage === totalPages;
    }
    
    if (this.pagination) {
      this.pagination.style.display = 'block';
    }
  }
  
  previousPage() {
    if (this.currentPage > 1) {
      this.currentPage--;
      this.showGridImages();
    }
  }
  
  nextPage() {
    const totalPages = Math.ceil(this.totalImages / this.imagesPerPage);
    if (this.currentPage < totalPages) {
      this.currentPage++;
      this.showGridImages();
    }
  }
  
  isMobile() {
    return window.innerWidth <= 768;
  }
  
  showCarousel() {
    // Mobile carousel implementation
    if (this.pagination) {
      this.pagination.style.display = 'none';
    }
    // Implementation for mobile carousel can be added here
  }
  
  throttledResize() {
    if (this.resizeTimer) return;
    
    this.resizeTimer = setTimeout(() => {
      const wasMobile = this.gallery?.classList.contains('carousel-mode');
      const nowMobile = this.isMobile();
      
      if (wasMobile !== nowMobile) {
        if (nowMobile) {
          this.showCarousel();
        } else {
          this.showGridImages();
        }
      }
      
      this.resizeTimer = null;
    }, 250);
  }
  
  initializeFancybox() {
    // Initialize fancybox if available
    setTimeout(() => {
      if (typeof jQuery !== 'undefined' && jQuery.fancybox) {
        jQuery('[data-fancybox="gallery2"]').fancybox({
          arrows: true,
          infobar: false,
          smallBtn: true,
          toolbar: true,
          preload: [2, 2],
          animationEffect: 'fade',
          animationDuration: 300,
          transitionEffect: 'slide',
          transitionDuration: 300
        });
      }
    }, 50);
  }
}

// WebP support detection
class WebPSupport {
  constructor() {
    this.detectWebPSupport();
  }
  
  detectWebPSupport() {
    const webP = new Image();
    webP.onload = webP.onerror = () => {
      if (webP.height === 2) {
        document.documentElement.classList.add('webp');
      } else {
        document.documentElement.classList.add('no-webp');
      }
    };
    webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
  }
}

// Performance monitoring
class PerformanceMonitor {
  constructor() {
    this.init();
  }
  
  init() {
    if ('PerformanceObserver' in window) {
      this.observeLCP();
      this.observeFID();
    }
  }
  
  observeLCP() {
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.entryType === 'largest-contentful-paint') {
          console.log('LCP:', entry.startTime);
        }
      });
    });
    observer.observe({entryTypes: ['largest-contentful-paint']});
  }
  
  observeFID() {
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.entryType === 'first-input') {
          console.log('FID:', entry.processingStart - entry.startTime);
        }
      });
    });
    observer.observe({entryTypes: ['first-input']});
  }
}

// Service Worker registration
class ServiceWorkerManager {
  constructor() {
    this.init();
  }
  
  init() {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered: ', registration);
          })
          .catch((registrationError) => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  }
}

// Initialize all components when DOM is ready
function initializeApp() {
  new PreloaderManager();
  new MobileMenu();
  new SmoothScroll();
  new HeaderScroll();
  new LazyLoader();
  new OptimizedGallery();
  new WebPSupport();
  new PerformanceMonitor();
  new ServiceWorkerManager();
}

// DOM ready check
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  initializeApp();
}

})();
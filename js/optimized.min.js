// Optimized JavaScript - Performance-focused rewrite
(function() {
'use strict';

// Performance-optimized preloader
class PreloaderManager {
  constructor() {
    this.preloader = document.getElementById('mainPreloader');
    this.progressBar = document.getElementById('progressBar');
    this.progressPercentage = document.getElementById('progressPercentage');
    this.progress = 0;
    this.loadedResources = 0;
    this.totalResources = 8;
    this.galleryImagesLoaded = 0;
    this.totalGalleryImages = 12;
    this.isGalleryLoading = false;
    
    this.init();
  }
  
  init() {
    this.bindEvents();
    this.simulateResourceLoading();
    this.setFailsafe();
  }
  
  bindEvents() {
    window.updatePreloaderProgress = (percentage) => this.updateProgress(percentage);
    window.setGalleryLoadingMode = (totalImages) => this.setGalleryLoadingMode(totalImages);
    window.incrementGalleryProgress = () => this.incrementGalleryProgress();
  }
  
  updateProgress(percentage) {
    this.progress = Math.min(percentage, 100);
    this.progressBar.style.width = this.progress + '%';
    this.progressPercentage.textContent = Math.round(this.progress) + '%';
  }
  
  setGalleryLoadingMode(totalImages) {
    this.isGalleryLoading = true;
    this.totalGalleryImages = totalImages;
    this.galleryImagesLoaded = 0;
    this.totalResources = 8 + totalImages;
    const baseProgress = (8 / this.totalResources) * 100;
    this.updateProgress(baseProgress);
  }
  
  incrementGalleryProgress() {
    if (this.isGalleryLoading) {
      this.galleryImagesLoaded++;
      const galleryProgress = (this.galleryImagesLoaded / this.totalGalleryImages) * 30;
      const baseProgress = 70;
      this.updateProgress(baseProgress + galleryProgress);
      
      if (this.galleryImagesLoaded >= this.totalGalleryImages) {
        this.finishPreloader();
      }
    }
  }
  
  incrementProgress() {
    this.loadedResources++;
    const newProgress = (this.loadedResources / this.totalResources) * (this.isGalleryLoading ? 70 : 90);
    this.updateProgress(newProgress);
  }
  
  finishPreloader() {
    setTimeout(() => {
      this.updateProgress(100);
      setTimeout(() => {
        this.preloader.classList.add('hidden');
        setTimeout(() => {
          if (this.preloader.parentNode) {
            this.preloader.parentNode.removeChild(this.preloader);
          }
        }, 500);
      }, 300);
    }, 200);
  }
  
  simulateResourceLoading() {
    const resources = [
      { name: 'CSS', delay: 200 },
      { name: 'Fonts', delay: 400 },
      { name: 'JavaScript', delay: 300 },
      { name: 'Hero Image', delay: 500 },
      { name: 'Service Images', delay: 600 },
      { name: 'Gallery System', delay: 300 },
      { name: 'Form Scripts', delay: 200 },
      { name: 'Final Setup', delay: 400 }
    ];
    
    resources.forEach((resource, index) => {
      setTimeout(() => {
        this.incrementProgress();
        if (this.loadedResources === 8 && !this.isGalleryLoading) {
          this.finishPreloader();
        }
      }, resource.delay + index * 100);
    });
  }
  
  setFailsafe() {
    setTimeout(() => {
      if (this.preloader && !this.preloader.classList.contains('hidden')) {
        this.finishPreloader();
      }
    }, 6000);
  }
}

// Optimized mobile menu
class MobileMenu {
  constructor() {
    this.burger = document.querySelector('.burger');
    this.headerCol = document.querySelector('.header__col');
    this.navigation = document.querySelector('#navigation');
    this.menuUl = document.querySelector('.head__mn-ul');
    this.body = document.body;
    this.menuLinks = document.querySelectorAll('.head__mn-ul li a');
    
    this.init();
  }
  
  init() {
    this.bindEvents();
    this.createMobileMenu();
  }
  
  createMobileMenu() {
    if (!this.menuUl) return;
    
    // Create mobile menu container if it doesn't exist
    if (!document.querySelector('.mobile-menu')) {
      const mobileMenu = document.createElement('div');
      mobileMenu.className = 'mobile-menu';
      mobileMenu.innerHTML = `
        <nav class="mobile-nav">
          <ul class="mobile-menu-list">
            <li><a href="./index.html">HOME</a></li>
            <li><a href="#Leistungen">LEISTUNGEN</a></li>
            <li><a href="#Ueber-uns">√úBER UNS</a></li>
            <li><a href="#Projekte">PROJEKTE</a></li>
            <li><a href="#Kontakt">KONTAKT</a></li>
          </ul>
          <div class="mobile-contact">
            <a href="tel:+491782747470" class="mobile-phone">üìû +49 178 2747470</a>
            <a href="https://wa.me/+491782747470" class="mobile-whatsapp">üí¨ WhatsApp</a>
          </div>
        </nav>
      `;
      document.body.appendChild(mobileMenu);
      
      // Update references
      this.mobileMenu = mobileMenu;
      this.mobileMenuLinks = mobileMenu.querySelectorAll('a');
    }
  }
  
  bindEvents() {
    this.burger?.addEventListener('click', () => this.toggleMenu());
    this.body.addEventListener('click', (e) => this.handleBodyClick(e));
    
    // Bind mobile menu links
    if (this.mobileMenuLinks) {
      this.mobileMenuLinks.forEach(link => {
        link.addEventListener('click', () => this.closeMenu());
      });
    }
    
    // Bind desktop menu links
    this.menuLinks.forEach(link => {
      link.addEventListener('click', () => this.closeMenu());
    });
  }
  
  toggleMenu() {
    const isOpen = this.burger?.classList.contains('burger-open');
    
    if (isOpen) {
      this.closeMenu();
    } else {
      this.openMenu();
    }
  }
  
  openMenu() {
    this.burger?.classList.add('burger-open');
    this.body.classList.add('body-open');
    this.mobileMenu?.classList.add('open');
    
    // Update aria-expanded for accessibility
    this.burger?.setAttribute('aria-expanded', 'true');
  }
  
  closeMenu() {
    this.burger?.classList.remove('burger-open');
    this.body.classList.remove('body-open');
    this.mobileMenu?.classList.remove('open');
    
    // Update aria-expanded for accessibility
    this.burger?.setAttribute('aria-expanded', 'false');
  }
  
  handleBodyClick(e) {
    if (this.burger?.classList.contains('burger-open') && 
        !e.target.closest('.mobile-menu') && 
        !e.target.closest('.burger')) {
      this.closeMenu();
    }
  }
}

// Optimized smooth scroll
class SmoothScroll {
  constructor() {
    this.anchorLinks = document.querySelectorAll('a[href^="#"]');
    this.init();
  }
  
  init() {
    this.bindEvents();
  }
  
  bindEvents() {
    this.anchorLinks.forEach(link => {
      link.addEventListener('click', (e) => this.handleClick(e));
    });
  }
  
  handleClick(e) {
    e.preventDefault();
    const targetId = e.currentTarget.getAttribute('href').substring(1);
    const targetElement = document.getElementById(targetId);
    
    if (targetElement) {
      const headerHeight = document.querySelector('.head')?.offsetHeight || 80;
      const targetPosition = targetElement.offsetTop - headerHeight - 20;
      this.smoothScrollTo(targetPosition, 400);
    }
  }
  
  smoothScrollTo(targetPosition, duration = 600) {
    const startPosition = window.pageYOffset;
    const distance = targetPosition - startPosition;
    let startTime = null;

    const animation = (currentTime) => {
      if (startTime === null) startTime = currentTime;
      const timeElapsed = currentTime - startTime;
      const run = this.easeInOutQuad(timeElapsed, startPosition, distance, duration);
      window.scrollTo(0, run);
      if (timeElapsed < duration) requestAnimationFrame(animation);
    };

    requestAnimationFrame(animation);
  }
  
  easeInOutQuad(t, b, c, d) {
    t /= d / 2;
    if (t < 1) return c / 2 * t * t + b;
    t--;
    return -c / 2 * (t * (t - 2) - 1) + b;
  }
}

// Optimized header scroll effect
class HeaderScroll {
  constructor() {
    this.header = document.querySelector('.head');
    this.throttleTimer = null;
    this.init();
  }
  
  init() {
    this.bindEvents();
  }
  
  bindEvents() {
    window.addEventListener('scroll', () => this.throttledScroll());
  }
  
  throttledScroll() {
    if (this.throttleTimer) return;
    
    this.throttleTimer = setTimeout(() => {
      this.handleScroll();
      this.throttleTimer = null;
    }, 10);
  }
  
  handleScroll() {
    if (window.scrollY > 50) {
      this.header?.classList.add('scrolled');
    } else {
      this.header?.classList.remove('scrolled');
    }
  }
}

// Optimized lazy loading for images
class LazyLoader {
  constructor() {
    this.images = document.querySelectorAll('img[loading="lazy"]');
    this.observer = null;
    this.init();
  }
  
  init() {
    if ('IntersectionObserver' in window) {
      this.setupIntersectionObserver();
    } else {
      this.loadAllImages();
    }
  }
  
  setupIntersectionObserver() {
    this.observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          this.loadImage(entry.target);
          this.observer.unobserve(entry.target);
        }
      });
    }, {
      rootMargin: '50px 0px',
      threshold: 0.01
    });
    
    this.images.forEach(img => this.observer.observe(img));
  }
  
  loadImage(img) {
    if (img.dataset.src) {
      img.src = img.dataset.src;
      img.removeAttribute('data-src');
    }
    
    img.addEventListener('load', () => {
      img.classList.add('loaded');
    });
  }
  
  loadAllImages() {
    this.images.forEach(img => this.loadImage(img));
  }
}

// Optimized gallery with pagination
class OptimizedGallery {
  constructor() {
    this.gallery = document.getElementById('galleryGrid');
    this.loader = document.getElementById('galleryLoading');
    this.pagination = document.getElementById('pagination');
    this.prevBtn = document.getElementById('prevPage');
    this.nextBtn = document.getElementById('nextPage');
    this.pageInfo = document.getElementById('pageInfo');
    
    this.totalImages = 180;
    this.currentPage = 1;
    this.imagesPerPage = 12;
    this.loadedImageCount = 0;
    
    this.init();
  }
  
  init() {
    if (!this.gallery) {
      console.warn('Gallery container not found');
      return;
    }
    
    console.log('üé® Initializing OptimizedGallery');
    this.bindEvents();
    this.initializeGallery();
  }
  
  bindEvents() {
    this.prevBtn?.addEventListener('click', () => this.previousPage());
    this.nextBtn?.addEventListener('click', () => this.nextPage());
    window.addEventListener('resize', () => this.throttledResize());
  }
  
  initializeGallery() {
    console.log('üñºÔ∏è Initializing gallery with', this.totalImages, 'images');
    
    if (typeof window.setGalleryLoadingMode === 'function') {
      window.setGalleryLoadingMode(this.imagesPerPage);
    }
    
    this.hideLoader();
    this.showGallery();
    
    // –ü—Ä–æ—Å—Ç–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    this.showSimpleGallery();
  }

  showSimpleGallery() {
    console.log('üì∏ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –≥–∞–ª–µ—Ä–µ—é');
    
    this.gallery.innerHTML = '';
    this.gallery.className = 'simple-gallery active';
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –ø–æ–∫–∞–∑–∞
    const imagesToShow = this.isMobile() ? 10 : this.imagesPerPage;
    
    for (let i = 0; i < imagesToShow && i < this.totalImages; i++) {
      const imageNumber = i + 1;
      if (imageNumber === 42) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      
      const imageElement = this.createSimpleImageElement(imageNumber);
      this.gallery.appendChild(imageElement);
    }
    
    console.log(`‚úÖ –ü–æ–∫–∞–∑–∞–ª–∏ ${imagesToShow} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`);
  }

  createSimpleImageElement(imageNumber) {
    const imgSrc = `img/image_${imageNumber}.webp`;
    const fallbackSrc = `img/image_${imageNumber}.jpg`;
    
    const div = document.createElement('div');
    div.className = 'simple-gallery-item';
    
    div.innerHTML = `
      <div class="gallery-item-wrapper">
        <picture>
          <source srcset="${imgSrc}" type="image/webp">
          <img 
            src="${fallbackSrc}" 
            alt="Gartenbau Projekt ${imageNumber} - Stuttgart Region"
            loading="lazy"
            decoding="async"
            class="gallery-image"
          >
        </picture>
        <div class="gallery-overlay">
          <div class="overlay-content">
            <button class="view-button" onclick="window.openImageModal('${imgSrc}', ${imageNumber})">
              <span class="view-icon">üëÅ</span>
              <span class="view-text">Ansehen</span>
            </button>
          </div>
        </div>
      </div>
    `;
    
    return div;
  }
  
  hideLoader() {
    if (this.loader) {
      this.loader.style.display = 'none';
    }
  }
  
  showGallery() {
    if (this.gallery) {
      this.gallery.style.display = 'grid';
    }
  }
  
  createImageElement(imageNumber) {
    const imgSrc = `img/image_${imageNumber}.webp`;
    const a = document.createElement('a');
    a.href = imgSrc;
    a.className = 'premium-gallery-item';
    a.setAttribute('data-fancybox', 'gallery2');

    const img = document.createElement('img');
    img.src = imgSrc;
    img.loading = 'lazy';
    img.decoding = 'async';
    img.alt = `Gartenbau Projekt ${imageNumber} - Stuttgart Region`;
    img.className = 'gallery-image';
    
    const overlay = document.createElement('div');
    overlay.className = 'gallery-overlay';
    overlay.innerHTML = `
      <div class="overlay-content">
        <div class="view-button">
          <span class="view-icon">üëÅ</span>
          <span class="view-text">Ansehen</span>
        </div>
      </div>
    `;
    
    img.addEventListener('load', () => {
      this.loadedImageCount++;
      if (typeof window.incrementGalleryProgress === 'function') {
        window.incrementGalleryProgress();
      }
    });
    
    img.addEventListener('error', () => {
      this.loadedImageCount++;
      img.alt = `Projekt ${imageNumber} - Bild nicht verf√ºgbar`;
      if (typeof window.incrementGalleryProgress === 'function') {
        window.incrementGalleryProgress();
      }
    });
    
    a.appendChild(img);
    a.appendChild(overlay);
    return a;
  }
  
  showGridImages() {
    const startIndex = (this.currentPage - 1) * this.imagesPerPage;
    const endIndex = startIndex + this.imagesPerPage;
    
    this.gallery.innerHTML = '';
    this.gallery.className = 'premium-gallery-grid active';
    this.loadedImageCount = 0;
    
    for (let i = startIndex; i < endIndex && i < this.totalImages; i++) {
      const imageNumber = i + 1;
      if (imageNumber === 42) continue;
      
      const imageElement = this.createImageElement(imageNumber);
      this.gallery.appendChild(imageElement);
    }
    
    this.updatePagination();
    this.initializeFancybox();
  }
  
  updatePagination() {
    const totalPages = Math.ceil(this.totalImages / this.imagesPerPage);
    
    if (this.pageInfo) {
      this.pageInfo.textContent = `Seite ${this.currentPage} von ${totalPages}`;
    }
    
    if (this.prevBtn) {
      this.prevBtn.disabled = this.currentPage === 1;
    }
    
    if (this.nextBtn) {
      this.nextBtn.disabled = this.currentPage === totalPages;
    }
    
    if (this.pagination) {
      this.pagination.style.display = 'block';
    }
  }
  
  previousPage() {
    if (this.currentPage > 1) {
      this.currentPage--;
      this.showGridImages();
    }
  }
  
  nextPage() {
    const totalPages = Math.ceil(this.totalImages / this.imagesPerPage);
    if (this.currentPage < totalPages) {
      this.currentPage++;
      this.showGridImages();
    }
  }
  
  isMobile() {
    return window.innerWidth <= 768;
  }
  
  showCarousel() {
    // Mobile carousel implementation
    if (this.pagination) {
      this.pagination.style.display = 'none';
    }
    // Implementation for mobile carousel can be added here
  }
  
  throttledResize() {
    if (this.resizeTimer) return;
    
    this.resizeTimer = setTimeout(() => {
      const wasMobile = this.gallery?.classList.contains('carousel-mode');
      const nowMobile = this.isMobile();
      
      if (wasMobile !== nowMobile) {
        if (nowMobile) {
          this.showCarousel();
        } else {
          this.showGridImages();
        }
      }
      
      this.resizeTimer = null;
    }, 250);
  }
  
  initializeFancybox() {
    // Initialize fancybox if available
    setTimeout(() => {
      if (typeof jQuery !== 'undefined' && jQuery.fancybox) {
        jQuery('[data-fancybox="gallery2"]').fancybox({
          arrows: true,
          infobar: false,
          smallBtn: true,
          toolbar: true,
          preload: [2, 2],
          animationEffect: 'fade',
          animationDuration: 300,
          transitionEffect: 'slide',
          transitionDuration: 300
        });
      }
    }, 50);
  }
}

// WebP support detection
class WebPSupport {
  constructor() {
    this.detectWebPSupport();
  }
  
  detectWebPSupport() {
    const webP = new Image();
    webP.onload = webP.onerror = () => {
      if (webP.height === 2) {
        document.documentElement.classList.add('webp');
      } else {
        document.documentElement.classList.add('no-webp');
      }
    };
    webP.src = 'data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA';
  }
}

// Performance monitoring
class PerformanceMonitor {
  constructor() {
    this.init();
  }
  
  init() {
    if ('PerformanceObserver' in window) {
      this.observeLCP();
      this.observeFID();
    }
  }
  
  observeLCP() {
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.entryType === 'largest-contentful-paint') {
          console.log('LCP:', entry.startTime);
        }
      });
    });
    observer.observe({entryTypes: ['largest-contentful-paint']});
  }
  
  observeFID() {
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.entryType === 'first-input') {
          console.log('FID:', entry.processingStart - entry.startTime);
        }
      });
    });
    observer.observe({entryTypes: ['first-input']});
  }
}

// Service Worker registration
class ServiceWorkerManager {
  constructor() {
    this.init();
  }
  
  init() {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered: ', registration);
          })
          .catch((registrationError) => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  }
}

// Premium Hero Slider
class HeroSlider {
  constructor() {
    this.slider = document.getElementById('heroSlider');
    this.slides = document.querySelectorAll('.hero-slide');
    this.dots = document.querySelectorAll('.nav-dot');
    this.prevBtn = document.getElementById('heroPrev');
    this.nextBtn = document.getElementById('heroNext');
    this.progressBar = document.getElementById('heroProgress');
    
    this.currentSlide = 0;
    this.totalSlides = this.slides.length;
    this.isAutoplay = true;
    this.autoplayDelay = 6000;
    this.progressInterval = null;
    this.autoplayTimer = null;
    
    this.init();
  }
  
  init() {
    if (!this.slider || this.totalSlides === 0) return;
    
    this.setupBackgroundImages();
    this.bindEvents();
    this.startAutoplay();
    this.updateSlideContent();
    
    console.log('üé¨ Hero Slider initialized with', this.totalSlides, 'slides');
  }
  
  setupBackgroundImages() {
    this.slides.forEach(slide => {
      const bgImage = slide.dataset.bg;
      if (bgImage) {
        slide.style.backgroundImage = `url(${bgImage})`;
      }
    });
  }
  
  bindEvents() {
    // Dots navigation
    this.dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        this.goToSlide(index);
        this.pauseAutoplay();
      });
    });
    
    // Arrow navigation
    this.prevBtn?.addEventListener('click', () => {
      this.previousSlide();
      this.pauseAutoplay();
    });
    
    this.nextBtn?.addEventListener('click', () => {
      this.nextSlide();
      this.pauseAutoplay();
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        this.previousSlide();
        this.pauseAutoplay();
      } else if (e.key === 'ArrowRight') {
        this.nextSlide();
        this.pauseAutoplay();
      }
    });
    
    // Touch/swipe support
    this.setupTouchEvents();
    
    // Pause on hover
    this.slider.addEventListener('mouseenter', () => this.pauseAutoplay());
    this.slider.addEventListener('mouseleave', () => this.resumeAutoplay());
    
    // Pause when page is not visible
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        this.pauseAutoplay();
      } else {
        this.resumeAutoplay();
      }
    });
  }
  
  setupTouchEvents() {
    let startX = 0;
    let startY = 0;
    let endX = 0;
    let endY = 0;
    
    this.slider.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
    }, { passive: true });
    
    this.slider.addEventListener('touchend', (e) => {
      endX = e.changedTouches[0].clientX;
      endY = e.changedTouches[0].clientY;
      
      const deltaX = endX - startX;
      const deltaY = endY - startY;
      
      // Only trigger if horizontal swipe is greater than vertical
      if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
        if (deltaX > 0) {
          this.previousSlide();
        } else {
          this.nextSlide();
        }
        this.pauseAutoplay();
      }
    }, { passive: true });
  }
  
  goToSlide(index) {
    if (index < 0 || index >= this.totalSlides || index === this.currentSlide) return;
    
    const currentSlideEl = this.slides[this.currentSlide];
    const nextSlideEl = this.slides[index];
    const currentDot = this.dots[this.currentSlide];
    const nextDot = this.dots[index];
    
    // Remove active classes
    currentSlideEl.classList.remove('active');
    currentDot?.classList.remove('active');
    
    // Add transition classes based on direction
    if (index > this.currentSlide) {
      currentSlideEl.classList.add('prev');
      nextSlideEl.style.transform = 'translateX(100%)';
    } else {
      currentSlideEl.classList.add('next');
      nextSlideEl.style.transform = 'translateX(-100%)';
    }
    
    // Force reflow
    nextSlideEl.offsetHeight;
    
    // Activate new slide
    setTimeout(() => {
      nextSlideEl.classList.add('active');
      nextSlideEl.style.transform = 'translateX(0)';
      nextDot?.classList.add('active');
      
      // Cleanup previous slide
      setTimeout(() => {
        currentSlideEl.classList.remove('prev', 'next');
        currentSlideEl.style.transform = '';
      }, 800);
    }, 50);
    
    this.currentSlide = index;
    this.resetProgress();
  }
  
  nextSlide() {
    const nextIndex = (this.currentSlide + 1) % this.totalSlides;
    this.goToSlide(nextIndex);
  }
  
  previousSlide() {
    const prevIndex = (this.currentSlide - 1 + this.totalSlides) % this.totalSlides;
    this.goToSlide(prevIndex);
  }
  
  startAutoplay() {
    if (!this.isAutoplay) return;
    
    this.resetProgress();
    this.autoplayTimer = setTimeout(() => {
      this.nextSlide();
      this.startAutoplay();
    }, this.autoplayDelay);
  }
  
  pauseAutoplay() {
    this.isAutoplay = false;
    if (this.autoplayTimer) {
      clearTimeout(this.autoplayTimer);
      this.autoplayTimer = null;
    }
    if (this.progressInterval) {
      clearInterval(this.progressInterval);
      this.progressInterval = null;
    }
  }
  
  resumeAutoplay() {
    if (this.autoplayTimer) return; // Already running
    
    this.isAutoplay = true;
    this.startAutoplay();
  }
  
  resetProgress() {
    if (this.progressInterval) {
      clearInterval(this.progressInterval);
    }
    
    if (!this.progressBar) return;
    
    this.progressBar.style.width = '0%';
    
    const step = 100 / (this.autoplayDelay / 100);
    let progress = 0;
    
    this.progressInterval = setInterval(() => {
      progress += step;
      this.progressBar.style.width = Math.min(progress, 100) + '%';
      
      if (progress >= 100) {
        clearInterval(this.progressInterval);
        this.progressInterval = null;
      }
    }, 100);
  }
  
  updateSlideContent() {
    // Add staggered animations to slide content
    this.slides.forEach((slide, index) => {
      const stats = slide.querySelectorAll('.stat-item, .feature-item, .benefit-item');
      stats.forEach((stat, i) => {
        stat.style.setProperty('--delay', `${i * 0.1}s`);
      });
    });
  }
}

// Initialize all components when DOM is ready
function initializeApp() {
  new PreloaderManager();
  new MobileMenu();
  new SmoothScroll();
  new HeaderScroll();
  new LazyLoader();
  new HeroSlider();
  // Don't auto-initialize gallery here, it will be done manually
  new WebPSupport();
  new PerformanceMonitor();
  new ServiceWorkerManager();
}

// Simple image modal for gallery
window.openImageModal = function(imageSrc, imageNumber) {
  const modal = document.createElement('div');
  modal.className = 'image-modal';
  modal.innerHTML = `
    <div class="modal-overlay" onclick="document.body.removeChild(this.parentNode)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="document.body.removeChild(this.parentNode.parentNode)">&times;</button>
        <img src="${imageSrc}" alt="Gartenbau Projekt ${imageNumber}" class="modal-image">
        <div class="modal-info">Projekt ${imageNumber}</div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
  
  // Close on escape
  const closeModal = (e) => {
    if (e.key === 'Escape') {
      document.body.removeChild(modal);
      document.body.style.overflow = '';
      document.removeEventListener('keydown', closeModal);
    }
  };
  document.addEventListener('keydown', closeModal);
};

// Export classes for manual initialization
window.OptimizedGallery = OptimizedGallery;
window.PreloaderManager = PreloaderManager;
window.MobileMenu = MobileMenu;
window.HeroSlider = HeroSlider;

// DOM ready check
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeApp);
} else {
  initializeApp();
}

})();